<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSE Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      .message {
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        background: #f0f0f0;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }
      #log {
        border: 1px solid #ddd;
        padding: 15px;
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        background: white;
        border-radius: 4px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #0056b3;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>üß™ SSE (Server-Sent Events) Test</h1>
    <p>This will test if your server supports SSE properly.</p>

    <div class="status" id="status" style="background: #ffc107">
      ‚è≥ Ready to test - Click the button below
    </div>

    <button onclick="startTest()">Start SSE Test</button>

    <h3>Log:</h3>
    <div id="log"></div>

    <h3>Console Output (press F12 to see):</h3>
    <p style="color: #666; font-size: 14px">
      Check browser console (F12 ‚Üí Console tab) for detailed technical
      information.
    </p>

    <script>
      let messageCount = 0;
      let eventSource = null;

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + type;
        msgDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
        logDiv.appendChild(msgDiv);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      function updateStatus(message, color) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.style.background = color;
      }

      function startTest() {
        if (eventSource) {
          eventSource.close();
        }

        document.getElementById("log").innerHTML = "";
        messageCount = 0;

        log("Starting SSE connection...", "info");
        updateStatus("üîÑ Connecting to server...", "#ffc107");

        try {
          eventSource = new EventSource("test-sse-simple.php");

          eventSource.addEventListener("open", function (e) {
            log("‚úÖ Connection opened successfully!", "success");
            updateStatus("‚úÖ Connected - Waiting for messages...", "#d4edda");
            console.log("EventSource opened:", e);
          });

          eventSource.addEventListener("test", function (e) {
            messageCount++;
            const data = JSON.parse(e.data);
            log(`Message ${data.number}: ${data.message}`, "info");
            updateStatus(`üì® Received ${messageCount} messages...`, "#d1ecf1");
            console.log("Test message received:", data);
          });

          eventSource.addEventListener("complete", function (e) {
            const data = JSON.parse(e.data);
            log("üéâ " + data.message, "success");
            updateStatus("‚úÖ Test Complete - SSE is working!", "#d4edda");
            console.log("Complete message received:", data);
            eventSource.close();
          });

          eventSource.onerror = function (e) {
            log("‚ùå Connection error occurred", "error");
            updateStatus(
              "‚ùå Connection Error - SSE may not be working",
              "#f8d7da"
            );
            console.error("EventSource error:", e);
            console.error("ReadyState:", eventSource.readyState);
            eventSource.close();

            if (messageCount === 0) {
              log(
                "‚ùå No messages received - SSE is NOT working on this server",
                "error"
              );
              log("üí° Possible causes:", "info");
              log("   ‚Ä¢ Server doesn't support SSE", "info");
              log("   ‚Ä¢ Output buffering is enabled", "info");
              log("   ‚Ä¢ Reverse proxy (nginx) blocking SSE", "info");
              log("   ‚Ä¢ PHP-FPM configuration issue", "info");
            } else {
              log(`Connection closed after ${messageCount} messages`, "error");
            }
          };

          // Timeout after 15 seconds
          setTimeout(() => {
            if (
              messageCount === 0 &&
              eventSource.readyState !== EventSource.CLOSED
            ) {
              log("‚è±Ô∏è Timeout: No messages received in 15 seconds", "error");
              updateStatus("‚ùå Timeout - SSE not working", "#f8d7da");
              eventSource.close();
            }
          }, 15000);
        } catch (err) {
          log("‚ùå Failed to create EventSource: " + err.message, "error");
          updateStatus("‚ùå Failed to start test", "#f8d7da");
          console.error("EventSource creation error:", err);
        }
      }

      // Show instructions
      log("Click the button above to start the test", "info");
      console.log("=== SSE Test Ready ===");
      console.log("This will test if Server-Sent Events work on your server");
      console.log(
        "Expected: 10 messages over 10 seconds, then completion message"
      );
    </script>
  </body>
</html>
